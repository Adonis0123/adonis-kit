name: Release Prepare

on:
  workflow_dispatch:
    inputs:
      package:
        description: Select publishable package
        required: true
        type: choice
        options:
          - '@adonis-kit/react-layouts'
          - '@adonis-kit/ui'
      bump:
        description: Select version bump type
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      summary:
        description: Changeset summary
        required: false
        default: manual release via workflow_dispatch

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure no open release PR
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner
            const repo = context.repo.repo
            const defaultBranch = context.payload.repository?.default_branch ?? 'main'

            const { data: pulls } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              base: defaultBranch,
              per_page: 100,
            })

            const blockers = pulls.filter((pr) => {
              const title = pr.title ?? ''
              const headRef = pr.head?.ref ?? ''
              return (
                title.startsWith('chore(release):') ||
                headRef.startsWith('release-prepare-') ||
                headRef.startsWith('changeset-release/')
              )
            })

            if (blockers.length === 0) {
              core.info(`No blocking release PR found on base branch "${defaultBranch}".`)
              return
            }

            const summary = blockers
              .map((pr) => `#${pr.number} ${pr.title} (${pr.html_url})`)
              .join('\n')

            core.setFailed(
              `Found open release PR(s) targeting "${defaultBranch}". Merge/close them before running Release Prepare again:\n${summary}`
            )

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate changeset config
        run: node scripts/release/validate-changeset-config.mjs

      - name: Create changeset
        id: create_changeset
        run: node scripts/release/create-changeset.mjs
        env:
          RELEASE_PACKAGE: ${{ inputs.package }}
          RELEASE_BUMP: ${{ inputs.bump }}
          RELEASE_SUMMARY: ${{ inputs.summary }}
          RUN_ID: ${{ github.run_id }}
          RUN_ATTEMPT: ${{ github.run_attempt }}

      - name: Apply version changes
        run: pnpm version-packages

      - name: Build selected package
        run: pnpm turbo run build --filter=${{ inputs.package }}

      - name: Test react-layouts
        if: inputs.package == '@adonis-kit/react-layouts'
        run: pnpm -C packages/react-layouts test

      - name: Create release prepare PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(release): prepare ${{ inputs.package }} ${{ inputs.bump }}"
          title: "chore(release): prepare ${{ inputs.package }} (${{ inputs.bump }})"
          body: |
            ## Release Prepare
            - Package: `${{ inputs.package }}`
            - Bump: `${{ inputs.bump }}`
            - Summary: `${{ inputs.summary }}`
            - Changeset file (consumed by `pnpm version-packages`): `${{ steps.create_changeset.outputs.changeset_path }}`
            - This PR should include package version and changelog updates.
          branch: "release-prepare-${{ steps.create_changeset.outputs.package_slug }}-${{ github.run_id }}-${{ github.run_attempt }}"
          delete-branch: true
